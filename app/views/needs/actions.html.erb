<% content_for :page_title, "Actions" %>

<article id="single-need">
  <nav class="add-top-margin">
    <ul class="breadcrumb">
      <li><%= link_to "All needs", needs_path %> <span class="divider">/</span></li>
      <li><%= link_to "#{@need.need_id}: #{format_need_goal @need.goal}", need_path(@need) %> <span class="divider">/</span></li>
      <li class="active">Actions</li>
    </ul>
  </nav>

  <%= render :partial => "need_header", locals: { active: "Actions" } %>

  <div id="actions">
    <h2>
      Mark as out of scope
      <br/>
      <small>
        <% if @need.out_of_scope? %>
          <strong>This need is not in scope for GOV.UK</strong>
        <% else %>
          This need will be editable, but won't be considered for adding to GOV.UK content
        <% end %>
      </small>
    </h2>
    <% if @need.out_of_scope? %>
      <%= link_to "Mark as out of scope",
                  "#",
                  id: 'out-of-scope',
                  disabled: "",
                  class: "btn btn-disabled" %>
    <% else %>
      <%= link_to "Mark as out of scope",
                  out_of_scope_need_path(@need),
                  id: 'out-of-scope',
                  class: "btn btn-danger" %>
    <% end %>
    <hr/>
    <h2>
        <% if @need.duplicate_of.blank? %>
          This need won't be editable as there is already an existing need that is better
          Close as a duplicate
          <br/>
          <small>
        <% else %>
          Reopen duplicate
          <br/>
          <small>
            <strong>This need is closed as a duplicate of <%= link_to "#{@need.duplicate_of}: #{@canonical_need_goal}", need_path(@need.duplicate_of) %></strong>
        <% end %>
      </small>
    </h2>
    <% if @need.duplicate_of.blank? %>
      <%= link_to "Close as a duplicate",
                  close_as_duplicate_need_path(@need),
                  id: 'close-as-duplicate',
                  class: "btn btn-danger" %>
    <% else %>
      <%= button_to "Reopen",
                    reopen_need_path(@need),
                    method: "delete",
                    class: "btn btn-danger" %>
    <% end %>
    </p>
  </div>

  <script>
    $('#out-of-scope').
    attr('href', '#out-of-scope-modal').
    attr('data-toggle', 'modal').
    attr('role', 'button')
  </script>
  <script>
    $('#close-as-duplicate').
    attr('href', '#close-as-duplicate-modal').
    attr('data-toggle', 'modal').
    attr('role', 'button')
  </script>

  <% unless @need.out_of_scope? %>
  <div id="out-of-scope-modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="modal-out-of-scope-label" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3 id="modal-out-of-scope-label">Mark as out of scope</h3>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to mark this need as out of scope? This can’t be changed.</p>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
      <%= button_to "Mark as out of scope",
                      descope_need_path(@need),
                      method: :put,
                      class: "btn btn-danger" %>
    </div>
  </div>
  <% end %>

  <% if @need.duplicate_of.blank? %>
    <div id="close-as-duplicate-modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="close-as-duplicate-label" aria-hidden="true">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="close-as-duplicate-label">Close as a duplicate</h3>
      </div>

  <%= semantic_form_for @need, { url: closed_need_path(@need) } do |f| %>
      <div class="modal-body">
        <%= f.input :duplicate_of,
                    :label => "This need is a duplicate of",
                    :hint => "ID of the need that this duplicates",
                    :input_html => { :type => :text,
                      :pattern => "[0-9]*"
                    }
                  %>
      </div>
      <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        <%= f.action :submit,
                     :button_html => {
                       :value => "Close as a duplicate",
                       :class => "btn btn-danger"
                     }
                   %>
      </div>
<% end %>

      </div>
    </div>
  <% end %>

  <%= render partial: "workflow_buttons", locals: { edit_page: false, view_page: false } %>

</article>
